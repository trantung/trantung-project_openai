<style>
    #fitem_id_overviewfiles_filemanager {
        margin-left: 0;
    }
    #fitem_id_overviewfiles_filemanager .col-md-3 {
        display: none !important;
        width: 0;
    }

    #fitem_id_overviewfiles_filemanager .col-md-9 {
        flex: 0 0 100%;
        max-width: 100%;
        padding-left: 0;
    }
</style>
<div id="form_image_edit" class="">
    <form autocomplete="off" action="https://english.ican.vn/classroom/local/omo_management/product/index.php" method="post" accept-charset="utf-8" id="mform1_NVWb7vX1sE77EUB" class="mform" data-boost-form-errors-enhanced="1">
        <div style="display: none;">
            <input name="sesskey" type="hidden" value="elt8O8b6jE">
            <input name="_qf__image_edit_form" type="hidden" value="1">
        </div>
        
        <div id="fitem_id_overviewfiles_filemanager" class="form-group row fitem">
            <div class="col-md-3 col-form-label d-flex pb-0 pr-md-0">
                <p id="id_overviewfiles_filemanager_label" class="mb-0 d-inline" aria-hidden="true" style="cursor: default;">
                    Hinh ảnh của khóa học
                </p>
    
                <div class="form-label-addon d-flex align-items-center align-self-start">
                    
                </div>
            </div>
            <div class="col-md-9 form-inline align-items-start felement" data-fieldtype="filemanager">
                <fieldset class="w-100 m-0 p-0 border-0" id="id_overviewfiles_filemanager_fieldset">
                    <legend class="sr-only">Hinh ảnh của khóa học</legend>
                    <div id="filemanager-671dac14e74d7" class="filemanager w-100 fm-loaded fm-nomkdir fm-nofiles fm-noitems">
                        <div class="fp-restrictions">
                            <span>Kích thước tối đa với một tập tin Không giới hạn, số lượng tập tin đính kèm tối đa:1</span>
                            <span class="dnduploadnotsupported-message"> - Kéo thả không được hỗ trợ<a class="btn btn-link p-0" role="button" data-container="body" data-toggle="popover" data-placement="right" data-content="<div class=&quot;no-overflow&quot;><p>Nếu có nhiều tệp trong thư mục, tệp chính là cái xuất hiện trên trang hiển thị. Các tệp khác như hình ảnh hay phim có thể được nhúng bên trong. Trong trình quản lí tệp tệp chính được chỉ dẫn với tiêu đề in đậm.</p>
                            </div> " data-html="true" tabindex="0" data-trigger="focus">
                                <i class="icon fa fa-question-circle text-info fa-fw " title="Trợ giúp về Đặt tập tin chính" aria-label="Trợ giúp về Đặt tập tin chính"></i>
                            </a></span>
                        </div>
                        <div class="fp-navbar bg-faded card mb-0">
                            <div class="filemanager-toolbar icon-no-spacing">
                                <div class="fp-toolbar">
                                    <div class="fp-btn-add">
                                        <a role="button" title="Thêm..." class="btn btn-secondary btn-sm" href="#">
                                            <i class="icon fa-regular fa-file fa-fw " aria-hidden="true"></i>
                                        </a>
                                    </div>
                                    <div class="fp-btn-mkdir">
                                        <a role="button" title="Tạo thư mục" class="btn btn-secondary btn-sm" href="#">
                                            <i class="icon fa fa-folder-o fa-fw " aria-hidden="true"></i>
                                        </a>
                                    </div>
                                    <div class="fp-btn-download">
                                        <a role="button" title="Tải" class="btn btn-secondary btn-sm" href="#">
                                            <i class="icon fa fa-download fa-fw " aria-hidden="true"></i>
                                        </a>
                                    </div>
                                    <div class="fp-btn-delete">
                                        <a role="button" title="Xoá" class="btn btn-secondary btn-sm" href="#">
                                            <i class="icon fa fa-trash fa-fw " aria-hidden="true"></i>
                                        </a>
                                    </div>
                                    <span class="fp-img-downloading">
                                        <span class="sr-only">Đang tải...</span>
                                        <i class="icon fa fa-circle-o-notch fa-spin fa-fw " aria-hidden="true"></i>
                                    </span>
                                </div>
                                <div class="fp-viewbar btn-group float-sm-right">
                                    <a title="Hiển thị thư mục với biểu tượng tệp" class="fp-vb-icons btn btn-secondary btn-sm">
                                        <i class="icon fa fa-th fa-fw " aria-hidden="true"></i>
                                    </a>
                                    <a title="Hiển thi thư mục với chi tiết tệp" class="fp-vb-details btn btn-secondary btn-sm checked">
                                        <i class="icon fa fa-list fa-fw " aria-hidden="true"></i>
                                    </a>
                                    <a title="Hiển thị thư mục như cây tập tin" class="fp-vb-tree btn btn-secondary btn-sm">
                                        <i class="icon fa fa-folder fa-fw " aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="fp-pathbar"><span class="fp-path-folder first last odd"><a class="fp-path-folder-name aalink" href="#">Tập tin</a></span></div>
                        </div>
                        <div class="filemanager-loading mdl-align"><i class="icon fa fa-circle-o-notch fa-spin fa-fw " aria-hidden="true"></i><span class="sr-only">Đang tải...</span></div>
                        <div class="filemanager-container card">
                            <div class="fm-content-wrapper">
                                <div class="fp-content">
                                    <div class="fp-tableview">
                                        <div class="yui3-widget yui3-datatable yui3-datatable-sortable">
                                            <div class="yui3-datatable-content">
                                                <table cellspacing="0" class="yui3-datatable-table" id="table-image-upload">
                                                    <thead class="yui3-datatable-columns">
                                                        <tr>
                                                            <th colspan="1" rowspan="1" class="yui3-datatable-header yui3-datatable-first-header scope="col">
                                                                <label class="sr-only">Chọn tất cả/không chọn gì</label>
                                                                <input type="checkbox" data-action="toggle" data-toggle="master" data-togglegroup="file-selections">
                                                            </th>
                                                            <th colspan="1" rowspan="1" class="yui3-datatable-header yui3-datatable-col-displayname yui3-datatable-sortable-column" scope="col" data-yui3-col-id="displayname" title="Sort by Tên">
                                                                <div class="yui3-datatable-sort-liner" tabindex="0" unselectable="on">
                                                                    Tên
                                                                    <span class="yui3-datatable-sort-indicator"></span>
                                                                </div>
                                                            </th>
                                                            <th colspan="1" rowspan="1" class="yui3-datatable-header yui3-datatable-col-datemodified yui3-datatable-sortable-column" scope="col" data-yui3-col-id="datemodified" title="Sort by Sửa lần cuối">
                                                                <div class="yui3-datatable-sort-liner" tabindex="0" unselectable="on">
                                                                    Sửa lần cuối
                                                                    <span class="yui3-datatable-sort-indicator"></span>
                                                                </div>
                                                            </th>
                                                            <th colspan="1" rowspan="1" class="yui3-datatable-header yui3-datatable-col-size yui3-datatable-sortable-column" scope="col" data-yui3-col-id="size" title="Sort by Kích thước">
                                                                <div class="yui3-datatable-sort-liner" tabindex="0" unselectable="on">
                                                                    Kích thước
                                                                    <span class="yui3-datatable-sort-indicator"></span>
                                                                </div>
                                                            </th>
                                                            <th colspan="1" rowspan="1" class="yui3-datatable-header yui3-datatable-col-mimetype yui3-datatable-sortable-column" scope="col" data-yui3-col-id="mimetype" title="Sort by Loại">
                                                                <div class="yui3-datatable-sort-liner" tabindex="0" unselectable="on">
                                                                    Loại<span class="yui3-datatable-sort-indicator"></span>
                                                                </div>
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <!-- <tbody class="yui3-datatable-message">
                                                        <tr>
                                                            <td class="yui3-datatable-message-content" colspan="5"></td>
                                                        </tr>
                                                    </tbody> -->
                                                    <tbody class="yui3-datatable-data">
                                                        
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="fp-iconview d-none">
                                    </div>
                                    <div class="fp-treeview d-none">
                                        <div class="ygtvitem" id="ygtv0">
                                            <div class="ygtvchildren" id="ygtvc0">
                                                <div class="ygtvitem" id="ygtv1">
                                                    <table id="ygtvtableel1" border="0" cellpadding="0" cellspacing="0"
                                                        class="ygtvtable ygtvdepth0 ygtv-expanded ygtv-highlight0 fp-folder">
                                                        <tbody>
                                                            <tr class="ygtvrow">
                                                                <td id="ygtvt1" class="ygtvcell ygtvlm">
                                                                    <a href="#" class="ygtvspacer">&nbsp;</a>
                                                                </td>
                                                                <td id="ygtvcontentel1" class="ygtvcell ygtvhtml ygtvcontent">
                                                                    <span
                                                                        class="fp-filename-icon fp-folder">
                                                                        <a href="#">
                                                                            <span class="fp-icon"><img
                                                                                    src="https://english.ican.vn/classroom/theme/image.php/mb2cg/core/1706779039/f/folder-24"></span>
                                                                            <span class="fp-reficons1"></span>
                                                                            <span class="fp-reficons2"></span>
                                                                            <span class="fp-filename">Tập tin</span>
                                                                        </a>
                                                                        <a class="fp-contextmenu" href="#" onclick="return false;">
                                                                            <i
                                                                                class="icon fa fa-ellipsis-v fa-fw " title="▶" aria-label="▶"></i>
                                                                            </a>
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    <div class="ygtvchildren" id="ygtvc1">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="fm-empty-container">
                                    <div class="dndupload-message">Thêm các tập tin bằng cách kéo thả.<br>
                                        <div class="dndupload-arrow"></div>
                                    </div>
                                </div>
                                <div class="dndupload-target">Tải các tập tin lên bằng việc thả chúng vào đây<br>
                                    <div class="dndupload-arrow"></div>
                                </div>
                                <div class="dndupload-progressbars"></div>
                                <div class="dndupload-uploadinprogress"><i class="icon fa fa-circle-o-notch fa-spin fa-fw " aria-hidden="true"></i><span class="sr-only">Đang tải...</span></div>
                            </div>
                            <div class="filemanager-updating"><i class="icon fa fa-circle-o-notch fa-spin fa-fw " aria-hidden="true"></i><span class="sr-only">Đang tải...</span></div>
                        </div>
                    </div>
                    <noscript>
                        <div>
                            <object type='text/html' data='https://english.ican.vn/classroom/repository/draftfiles_manager.php?env=filemanager&amp;action=browse&amp;itemid=116273913&amp;subdirs=0&amp;maxbytes=-1&amp;areamaxbytes=-1&amp;maxfiles=1&amp;ctx_id=1&amp;course=1&amp;sesskey=elt8O8b6jE' height='160' width='600' style='border:1px solid #000'></object>
                        </div>
                    </noscript>
                    <input value="116273913" name="overviewfiles_filemanager" type="hidden" id="id_overviewfiles_filemanager">
                    <input name="image_course" class="hidden" type="file" id="image_course">
                    <p>Accepted file types:</p>
                    <div class="form-filetypes-descriptions w-100">
                        <ul class="list-unstyled unstyled">
                            <li>Ảnh (GIF) <small class="text-muted muted">.gif</small></li>
                            <li>Ảnh (JPEG) <small class="text-muted muted">.jpg</small></li>
                            <li>Ảnh (PNG) <small class="text-muted muted">.png</small></li>
                        </ul>
                    </div>
                </fieldset>
                <div class="form-control-feedback invalid-feedback" id="id_error_overviewfiles_filemanager">
                    
                </div>
            </div>
        </div>
    </form>
</div>


<script>
    // $('#table-image-upload').DataTable({
    //     bLengthChange: false, // Ẩn phần "Show entries"
    //     bFilter: false         // Ẩn phần "Search"
    // }); 
    $(document).ready(function () {
        $('#table-image-upload thead input[type="checkbox"]').on('change', function() {
            var isChecked = $(this).is(':checked');
            
            $('#table-image-upload tbody input[type="checkbox"]').prop('checked', isChecked);
        });

        $('#table-image-upload tbody').on('change', 'input[type="checkbox"]', function() {
            var allChecked = $('#table-image-upload tbody input[type="checkbox"]').length === $('#table-image-upload tbody input[type="checkbox"]:checked').length;
            
            $('#table-image-upload thead input[type="checkbox"]').prop('checked', allChecked);
        });

        const $dropZone = $(".filemanager-container");
        const $fileManager = $(".filemanager.fm-loaded");
        let dragCounter = 0;
        let dropZoneCounter = 0;
        let leaveTimer;
        let uploadedImages = [];
        let uploadedFiles = [];

        // Ngăn chặn hành vi mặc định của các sự kiện
        $(document).on("dragenter dragover dragleave drop", function (e) {
            e.preventDefault();
            e.stopPropagation();
        });

        // Thêm class dndupload-ready khi người dùng bắt đầu kéo ảnh vào trang
        $(document).on("dragenter", function () {
            if (dragCounter === 0) { // Chỉ thêm class khi bắt đầu kéo vào trang
                clearTimeout(leaveTimer);
                $dropZone.addClass("dndupload-ready");
            }
            dragCounter++; // Tăng counter toàn cục
        });

        // Xóa class dndupload-ready khi rời khỏi toàn bộ trang
        $(document).on("dragleave", function () {
            dragCounter--;
            if (dragCounter === 0) { // Chỉ xóa khi không còn gì được kéo trên trang
                leaveTimer = setTimeout(() => {
                    $dropZone.removeClass("dndupload-ready");
                }, 100);
            }
        });

        // Thêm class dndupload-over khi ảnh vào phạm vi vùng thả
        $dropZone.on("dragenter", function () {
            dropZoneCounter++;
            if (dropZoneCounter === 1) { // Chỉ thêm class khi lần đầu vào vùng thả
                $dropZone.addClass("dndupload-over");
            }
        });

        // Xóa class dndupload-over khi ảnh rời khỏi vùng thả
        $dropZone.on("dragleave", function () {
            dropZoneCounter--;
            if (dropZoneCounter === 0) { // Chỉ xóa class khi hoàn toàn rời khỏi vùng thả
                $dropZone.removeClass("dndupload-over");
            }
        });

        // Bỏ cả dndupload-ready và dndupload-over khi ảnh được thả
        $dropZone.on("drop", function (e) {
            if ($fileManager.hasClass("fm-maxfiles")) {
                $dropZone.removeClass("dndupload-ready");
                alert("Đã đạt đến giới hạn file tối đa. Không thể thả thêm file vào.");
                return;
            }
            e.preventDefault();
            e.stopPropagation();
            $dropZone.removeClass("dndupload-ready dndupload-over");
            console.log("removeClass dndupload-ready dndupload-over");

            const files = e.originalEvent.dataTransfer.files;
            const validFiles = [];

            // Kiểm tra từng file
            Array.from(files).forEach(file => {
                if (file.type.startsWith("image/")) {
                    validFiles.push(file);
                } else {
                    alert(`File "${file.name}" không phải là file ảnh. Vui lòng chỉ thả file ảnh.`);
                }
            });

            // Nếu có file hợp lệ thì xử lý
            if (validFiles.length > 0) {
                handleFiles(validFiles);
                assignFilesToInput(validFiles);
                // Xóa class fm-noitems khi ảnh được thả vào
                $fileManager.removeClass("fm-noitems");
            }

            dragCounter = 0; // Reset counter khi thả file
        });

        function assignFilesToInput(files) {
            // Tạo một DataTransfer để gán file vào
            let dataTransfer = new DataTransfer();
            
            // Thêm các file được kéo vào DataTransfer
            Array.from(files).forEach(file => dataTransfer.items.add(file));
            
            // Gán DataTransfer vào input file
            const fileInput = document.getElementById('image_course');
            fileInput.files = dataTransfer.files;

            // Kích hoạt sự kiện change để các xử lý khác có thể nhận biết thay đổi này
            $(fileInput).trigger('change');
        }

        // Xử lý file sau khi gán vào input file
        $('#image_course').on('change', function () {
            const files = this.files;
            if (files.length > 0) {
                console.log("Files have been assigned to the input file:", files);
                // Thực hiện xử lý upload hoặc các thao tác khác với files
            }
        });

        function handleFiles(files) {
            // $.each(files, function (index, file) {
            //     loadImageUploadTable(file);
            // });
            $.each(files, function(index, file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const fileData = {
                        name: file.name,
                        size: (file.size / 1024).toFixed(2) + " KB",
                        type: file.type || "Không xác định",
                        url: event.target.result,
                        date: new Date().toLocaleString()
                    };
                    uploadedFiles.push(fileData);

                    // Cập nhật chế độ view hiện tại
                    updateView();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateView() {
            // Kiểm tra nút nào đang active để xác định chế độ hiển thị
            if ($(".fp-vb-details").hasClass("checked")) {
                showTableView();
            } else if ($(".fp-vb-icons").hasClass("checked")) {
                showIconView();
            } else if ($(".fp-vb-tree").hasClass("checked")) {
                showTreeView();
            }

            if (uploadedFiles.length > 0) {
                $fileManager.addClass("fm-maxfiles");
            } else {
                $fileManager.removeClass("fm-maxfiles");
            }
        }

        function showTableView() {
            var imageUploadTable;

            // Khởi tạo bảng nếu chưa tồn tại hoặc xóa nội dung cũ nếu đã có
            if ($.fn.dataTable.isDataTable('#table-image-upload')) {
                imageUploadTable = $('#table-image-upload').DataTable();
                imageUploadTable.clear();
            } else {
                imageUploadTable = $('#table-image-upload').DataTable({
                    "dom": '<"dt-buttons"lBf><"clear">rt',
                    "paging": false,
                    "autoWidth": true,
                    "bLengthChange": false,
                    "bFilter": false,
                    "order": [[1, 'asc']],
                    "columns": [
                        { "width": "5%", "orderable": false },
                        { "width": "30%" },
                        { "width": "20%" },
                        { "width": "20%" },
                        { "width": "25%" }
                    ]
                });
            }

            $('#table-image-upload tbody').empty();
            console.log(uploadedFiles);
            $.each(uploadedFiles, function(index, file) {
                var fileSize = (file.size / 1024).toFixed(2) + " KB";
                var fileType = file.type || "Không xác định";
                var fileName = file.name;
                var currentDate = new Date().toLocaleString();

                var row = `
                    <tr>
                        <td><input type="checkbox" class="image-checkbox" data-index="${index}"></td>
                        <td>
                            <span class="fp-filename-icon fp-hascontextmenu">
                                <a href="#">
                                    <span class="fp-icon"><img src="${file.url}" class="realpreview"></span>
                                    <span class="fp-filename">${fileName}</span>
                                </a>
                                <a class="fp-contextmenu" href="#" onclick="return false;">
                                    <i class="icon fa fa-ellipsis-v fa-fw" title="▶" aria-label="▶"></i>
                                </a>
                            </span>
                        </td>
                        <td>${currentDate}</td>
                        <td>${fileSize}</td>
                        <td>${fileType}</td>
                    </tr>`;
                // Thêm hàng vào bảng
                imageUploadTable.row.add($(row)).draw();
            });

            
            $(".fp-tableview").removeClass("d-none");
            $(".fp-iconview, .fp-treeview").addClass("d-none");
        }

        // Hàm hiển thị chế độ icon view
        function showIconView() {
            const iconView = $(".fp-iconview");
            iconView.empty();

            $.each(uploadedFiles, function(index, file) {
                const iconItem = `
                    <div class="fp-file fp-hascontextmenu">
                        <a href="#" class="d-block aabtn">
                            <div style="position:relative;">
                                <div class="fp-thumbnail" style="width: 112px; height: 112px;">
                                    <img title="${file.name}" alt="${file.name}" src="${file.url}" style="max-width: 90px; max-height: 90px;" class="realpreview">
                                </div>
                            </div>
                            <div class="fp-filename-field">
                                <div class="fp-filename text-truncate" style="width: 112px;">${file.name}</div>
                            </div>
                        </a>
                        <a class="fp-contextmenu btn btn-icon btn-light border icon-no-margin icon-size-3" href="#">
                            <span><i class="icon fa fa-ellipsis-v fa-fw" title="▶" aria-label="▶"></i></span>
                        </a>
                    </div>`;
                iconView.append(iconItem);
            });
            $(".fp-iconview").removeClass("d-none");
            $(".fp-tableview, .fp-treeview").addClass("d-none");
        }

        // Hàm hiển thị chế độ tree view
        function showTreeView() {
            const treeView = $(".fp-treeview #ygtvc1");
            treeView.empty();

            $.each(uploadedFiles, function(index, file) {
                const treeItem = `
                    <div class="ygtvitem" id="ygtv${index + 1}">
                        <table id="ygtvtableel2" border="0" cellpadding="0" cellspacing="0"
                            class="ygtvtable ygtvdepth1 ygtv-collapsed ygtv-highlight0 fp-hascontextmenu">
                            <tbody>
                                <tr class="ygtvrow">
                                    <td class="ygtvcell ygtvblankdepthcell">
                                        <div class="ygtvspacer"></div>
                                    </td>
                                    <td class="ygtvcell ygtvln">
                                        <div class="ygtvspacer"></div>
                                    </td>
                                    <td id="ygtvcontentel2" class="ygtvcell ygtvhtml ygtvcontent"><span
                                            class="fp-filename-icon fp-hascontextmenu">
                                            <a href="#">
                                                <span class="fp-icon"><img
                                                        src="${file.url}"
                                                        class="realpreview"></span>
                                                <span class="fp-reficons1"></span>
                                                <span class="fp-reficons2"></span>
                                                <span class="fp-filename">${file.name}</span>
                                            </a>
                                            <a class="fp-contextmenu" href="#" onclick="return false;"><i
                                                    class="icon fa fa-ellipsis-v fa-fw " title="▶"
                                                    aria-label="▶"></i></a>
                                        </span></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="ygtvchildren" id="ygtvc2" style="display:none;"></div>
                    </div>`;
                treeView.append(treeItem);
            });
            $(".fp-treeview").removeClass("d-none");
            $(".fp-tableview, .fp-iconview").addClass("d-none");
        }

        $(".fp-vb-icons").on("click", function() {
            $(this).addClass("checked");
            $(".fp-vb-details, .fp-vb-tree").removeClass("checked");
            updateView();
        });

        $(".fp-vb-details").on("click", function() {
            $(this).addClass("checked");
            $(".fp-vb-icons, .fp-vb-tree").removeClass("checked");
            updateView();
        });

        $(".fp-vb-tree").on("click", function() {
            $(this).addClass("checked");
            $(".fp-vb-icons, .fp-vb-details").removeClass("checked");
            updateView();
        });

        function loadImageUploadTable(file) {
            var imageUploadTable;

            // Khởi tạo bảng nếu chưa tồn tại hoặc xóa nội dung cũ nếu đã có
            if ($.fn.dataTable.isDataTable('#table-image-upload')) {
                imageUploadTable = $('#table-image-upload').DataTable();
            } else {
                imageUploadTable = $('#table-image-upload').DataTable({
                    "dom": '<"dt-buttons"lBf><"clear">rt',
                    "paging": false,
                    "autoWidth": true,
                    "bLengthChange": false,
                    "bFilter": false,
                    "order": [[1, 'asc']],
                    "columns": [
                        { "width": "5%", "orderable": false },
                        { "width": "30%" },
                        { "width": "20%" },
                        { "width": "20%" },
                        { "width": "25%" }
                    ]
                });
            }

            $('#table-image-upload tbody').empty();

            var fileSize = (file.size / 1024).toFixed(2) + " KB";
            var fileType = file.type || "Không xác định";
            var fileName = file.name;
            var currentDate = new Date().toLocaleString();

            var reader = new FileReader();
            reader.onload = function(event) {
                // Lưu thông tin ảnh vào mảng
                var imageIndex = uploadedImages.length;
                uploadedImages.push({
                    name: fileName,
                    size: fileSize,
                    type: fileType,
                    url: event.target.result,
                    date: currentDate
                });

                // Tạo hàng mới với dữ liệu của file và thêm data-index cho checkbox
                var row = `
                    <tr>
                        <td><input type="checkbox" class="image-checkbox" data-index="${imageIndex}"></td>
                        <td>
                            <span class="fp-filename-icon fp-hascontextmenu">
                                <a href="#">
                                    <span class="fp-icon"><img src="${event.target.result}" class="realpreview"></span>
                                    <span class="fp-filename">${fileName}</span>
                                </a>
                                <a class="fp-contextmenu" href="#" onclick="return false;">
                                    <i class="icon fa fa-ellipsis-v fa-fw" title="▶" aria-label="▶"></i>
                                </a>
                            </span>
                        </td>
                        <td>${currentDate}</td>
                        <td>${fileSize}</td>
                        <td>${fileType}</td>
                    </tr>`;

                // Thêm hàng vào bảng
                imageUploadTable.row.add($(row)).draw();
            };

            $fileManager.addClass("fm-maxfiles");

            reader.readAsDataURL(file);
        }

        $(document).on('click', '.fp-btn-download a', function(e) {
            e.preventDefault();

            // Lọc các checkbox đã được chọn
            var selectedImages = [];
            $('#table-image-upload .image-checkbox:checked').each(function() {
                var index = $(this).data('index');
                if (uploadedImages[index]) {
                    selectedImages.push(uploadedImages[index]);
                }
            });

            if (selectedImages.length > 0) {
                // Nếu có checkbox được chọn, tải xuống các ảnh đã chọn
                selectedImages.forEach(function(image) {
                    var link = document.createElement('a');
                    link.href = image.url;
                    link.download = image.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            } else {
                // Nếu không có checkbox nào được chọn, tạo file ZIP chứa tất cả các ảnh
                var zip = new JSZip();
                var imgFolder = zip.folder("images");

                uploadedImages.forEach(function(image) {
                    var base64Data = image.url.split(',')[1];
                    imgFolder.file(image.name, base64Data, {base64: true});
                });

                // Tạo file ZIP và tải xuống
                zip.generateAsync({type: "blob"}).then(function(content) {
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "images.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
        });

        let selectedIndexes = []; // Mảng để lưu trữ các chỉ số file được chọn

        // Khi click vào nút Delete
        $('.fp-btn-delete a').on('click', function(e) {
            e.preventDefault();
            
            uploadedFiles = [];
            // Lấy các checkbox đã được chọn
            var selectedIndexes = [];
            $('#table-image-upload tbody input[type="checkbox"]:checked').each(function() {
                var index = $(this).data('index'); 
                selectedIndexes.push(index);
            });
            
            var popupTitle = $('.delete-confirm-popup .popup-header h3');
            var popupMessage = $('.delete-confirm-popup .popup-body p');
            var confirmButton = $('.delete-confirm-popup .fp-dlg-butconfirm');
            var cancelButton = $('.delete-confirm-popup .fp-dlg-butcancel');

            if (selectedIndexes.length === 0) {
                popupTitle.text("Lỗi");
                popupMessage.text("Vui lòng chọn ít nhất một file để xóa.");
                confirmButton.off('click').on('click', function() {
                    $('.delete-confirm-popup').css('display', 'none');
                });
                cancelButton.hide();
            } else {
                popupTitle.text("Xác Nhận Xóa");
                popupMessage.text("Bạn có chắc muốn xóa những file đã được chọn?");
                confirmButton.off('click').on('click', function() {
                    deleteSelectedFiles(selectedIndexes); // Gọi hàm xóa file
                    $('.delete-confirm-popup').css('display', 'none');
                });
                cancelButton.show();
            }

            // Hiển thị popup
            $('.delete-confirm-popup').css('display', 'flex');
        });

        // Khi click vào nút xác nhận xóa
        function deleteSelectedFiles(selectedIndexes) {
            // Sắp xếp mảng selectedIndexes theo thứ tự giảm dần
            selectedIndexes.sort((a, b) => b - a);
            
            // Xóa file từ mảng uploadedImages
            selectedIndexes.forEach(function(index) {
                uploadedImages.splice(index, 1); // Xóa file tại vị trí index trong mảng
            });

            // Cập nhật bảng dữ liệu
            var imageUploadTable = $('#table-image-upload').DataTable();
            imageUploadTable.clear(); // Xóa tất cả các hàng hiện có

            // Thêm lại tất cả các hình ảnh còn lại vào bảng
            uploadedImages.forEach(function(image, index) {
                var row = `
                    <tr>
                        <td><input type="checkbox" class="image-checkbox" data-index="${index}"></td>
                        <td>
                            <span class="fp-filename-icon fp-hascontextmenu">
                                <a href="#">
                                    <span class="fp-icon"><img src="${image.url}" class="realpreview"></span>
                                    <span class="fp-filename">${image.name}</span>
                                </a>
                                <a class="fp-contextmenu" href="#" onclick="return false;">
                                    <i class="icon fa fa-ellipsis-v fa-fw" title="▶" aria-label="▶"></i>
                                </a>
                            </span>
                        </td>
                        <td>${image.date}</td>
                        <td>${image.size}</td>
                        <td>${image.type}</td>
                    </tr>`;
                
                imageUploadTable.row.add($(row));
            });

            imageUploadTable.draw(); // Vẽ lại bảng

            // Bỏ chọn ô header sau khi xóa
            $('#table-image-upload thead input[type="checkbox"]').prop('checked', false);

            if(uploadedImages.length == 0){
                $fileManager.removeClass("fm-maxfiles");
                $fileManager.addClass("fm-noitems");
            }

            document.getElementById('image_course').value = '';
        }

        // Khi click ra ngoài popup
        $(window).on('click', function(event) {
            if ($(event.target).is('#delete-confirm-popup')) {
                $('#delete-confirm-popup').hide(); // Ẩn popup nếu click ra ngoài
            }
        });

    });
</script>